{% extends 'base.html' %}

{% block title %}{{ post.title }}{% endblock title %}

{% block content %}
<h2>{{ post.title }}</h2>
<div>{{ post.description|safe }}</div>

<hr>

<h3>نظرات:</h3>

{% for comment in comments %}
<div style="margin-bottom: 1rem;">
  <strong>{{ comment.author.username }}</strong> گفت:
  <p>{{ comment.content }}</p>
  <small>{{ comment.write_date|date:"Y/m/d H:i" }}</small>

  {% if user == comment.author or user.is_staff or post.author == user %}
  <form method="post" action="{% url 'comment-delete' comment.id %}" style="display:inline;">
    {% csrf_token %}
    <button type="submit" style="color:red;">حذف</button>
  </form>
  {% endif %}

  {% for reply in comment.comment_set.all %}
  
  {% if reply.is_active %}  
<div style="margin-left: 2rem; border-left: 2px solid #ccc; padding-left: 1rem;">
  <strong>{{ reply.author.username }}</strong> پاسخ داد:
  <p>{{ reply.content }}</p>
  <small>{{ reply.write_date|date:"Y/m/d H:i" }}</small>

  {% if user == reply.author or user.is_staff %}
  <form method="post" action="{% url 'comment-delete' reply.id %}" style="display:inline;">
    {% csrf_token %}
    <button type="submit" style="color:red;">حذف</button>
  </form>
  {% endif %}
</div>
  {% endif %}
  {% endfor %}

  {% if user.is_authenticated %}
  <details>
    <summary>پاسخ بده</summary>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <input type="hidden" name="reply_to" value="{{ comment.id }}">
      <button type="submit">ارسال پاسخ</button>
    </form>
  </details>
  {% endif %}
</div>
{% empty %}
<p>هیچ نظری ثبت نشده است.</p>
{% endfor %}

<hr>

{% if user.is_authenticated %}
<h4>نظر جدید:</h4>
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">ارسال نظر</button>
</form>
{% else %}
<p>برای ارسال نظر ابتدا وارد شوید.</p>
{% endif %}

{% endblock content %}